!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Touchkit=e()}(this,function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(!(this instanceof e))return new e(t);this.use={drag:!1,pinch:!1,rotate:!1,singlePinch:!1,singleRotate:!1},this.operator=this.el=h.getEl(t),this.draging=this.pinching=this.rotating=this.singlePinching=this.singleRotating=!1,this.fingers=0,this.startScale=1,this.startPoint={},this.secondPoint={},this.pinchStartLength=null,this.singlePinchStartLength=null,this.vector1={},this.singleBasePoint={},this._driveBus(),this._bind()}function i(t,e){if(!(this instanceof i))return new i(t,e);this.ops={width:t||500,height:e||t},this.canvas=null,this.ctx=null,this.queue=[],this.end=null,this.textData={},this.bgConfig=null,this._init()}function n(){var t=document.createElement("style");return t.type="text/css",document.head.appendChild(t),t.sheet}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t){if(!(this instanceof s))return new s(t);this._ops={el:null,use:{drag:!1,pinch:!1,rotate:!1,singlePinch:!1,singleRotate:!1},limit:!1,event:{touchstart:function(){},touchmove:function(){},touchend:function(){},dragstart:function(){},drag:function(){},dragend:function(){},pinchstart:function(){},pinch:function(){},pinchend:function(){},rotatestart:function(){},rotate:function(){},rotatend:function(){},singlePinchstart:function(){},singlePinch:function(){},singlePinchend:function(){},singleRotatestart:function(){},singleRotate:function(){},singleRotatend:function(){}}},"object"==(void 0===t?"undefined":w(t))?this._ops=x.extend(this._ops,t):"string"==typeof t&&(this._ops.el=t),this.el=x.getEl(this._ops.el),this.elStatus={width:this.el.clientWidth||this.el.offsetWidth,height:this.el.clientHeight||this.el.offsetHeight},this._init(),this.mt=e(this.el),this._bind(),this._insertCss()}var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},a="function"==typeof Symbol&&"symbol"===r(Symbol.iterator)?function(t){return void 0===t?"undefined":r(t)}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":void 0===t?"undefined":r(t)},h={getLength:function(t){return"object"!==(void 0===t?"undefined":a(t))?void console.error("getLength error!"):Math.sqrt(t.x*t.x+t.y*t.y)},getAngle:function(t,e){if("object"!==(void 0===t?"undefined":a(t))||"object"!==(void 0===e?"undefined":a(e)))return void console.error("getAngle error!");var i=t.x*e.y-e.x*t.y>0?1:-1,n=this.getLength(t),o=this.getLength(e),s=n*o,r=void 0,h=void 0;return 0===s?0:(r=t.x*e.x+t.y*e.y,h=r/s,h>1&&(h=1),h<-1&&(h=-1),Math.acos(h)*i*180/Math.PI)},getBasePoint:function(t){if(!t)return{x:0,y:0};var e=this.getOffset(t),i=e.left+t.getBoundingClientRect().width/2,n=e.top+t.getBoundingClientRect().width/2;return{x:Math.round(i),y:Math.round(n)}},extend:function(t,e){for(var i in e)e.hasOwnProperty(i)&&("object"!=a(e[i])||e[i]instanceof Node?t[i]=e[i]:("object"!==a(t[i])&&(t[i]={}),this.extend(t[i],e[i])));return t},getVector:function(t,e){return"object"!==(void 0===t?"undefined":a(t))||"object"!==(void 0===e?"undefined":a(e))?void console.error("getvector error!"):{x:Math.round(t.x-e.x),y:Math.round(t.y-e.y)}},getPoint:function(t,e){return t&&t.touches[e]?{x:Math.round(t.touches[e].pageX),y:Math.round(t.touches[e].pageY)}:void console.error("getPoint error!")},getOffset:function(t){t="string"==typeof t?document.querySelector(t):t;var e=t.getBoundingClientRect();return{left:e.left+document.body.scrollLeft,top:e.top+document.body.scrollTop,width:t.offsetWidth,height:t.offsetHeight}},matrixTo:function(t){var e=t.replace("matrix(","").replace(")","").split(","),i=e[0],n=e[1],o=n/i,s=180*Math.atan(o)/Math.PI,r=i/Math.cos(Math.PI/180*s);return{x:parseInt(e[4]),y:parseInt(e[5]),scale:r,rotate:s}},getUseName:function(t){var e=t.replace("start",""),i=-1!==e.indexOf("rotate")?"nd":"end";return e=e.replace(i,"")},domify:function(t){var e=document.implementation.createHTMLDocument();return e.body.innerHTML=t,e.body.children},getEl:function(t){if(!t)return void console.error("el error,there must be a el!");var e=void 0;if("string"==typeof t)e=document.querySelector(t);else{if(!(t instanceof Node))return void console.error("el error,there must be a el!");e=t}return e},data:function(t,e){return t=this.getEl(t),t.getAttribute("data-"+e)},include:function(t,e){return!!t.indexOf&&-1!==t.indexOf(e)},getPos:function(t){if(t){t=this.getEl(t);var e=void 0,i=window.getComputedStyle(t,null),n=i.transform||i.webkitTransform;return e=window.getComputedStyle&&"none"!==n?this.matrixTo(n):{x:0,y:0,scale:1,rotate:0},JSON.parse(t.getAttribute("data-mtouch-status"))||e}}},c=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),l=function(){function e(i){t(this,e),this.handlers=[],this.el=i}return c(e,[{key:"add",value:function(t){return this.handlers.push(t),this}},{key:"del",value:function(t){var e=this;return t?this.handlers.forEach(function(i,n){i===t&&e.handlers.splice(n,1)}):this.handlers=[],this}},{key:"fire",value:function(){var t=this,e=arguments;if(this.handlers&&0!==!this.handlers.length)return this.handlers.forEach(function(i){"function"==typeof i&&i.apply(t.el,e)}),this}}]),e}(),d=function(){function t(t,e){var i=[],n=!0,o=!1,s=void 0;try{for(var r,a=t[Symbol.iterator]();!(n=(r=a.next()).done)&&(i.push(r.value),!e||i.length!==e);n=!0);}catch(t){o=!0,s=t}finally{try{!n&&a.return&&a.return()}finally{if(o)throw s}}return i}return function(e,i){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),u=["touchstart","touchmove","touchend","drag","dragstart","dragend","pinch","pinchstart","pinchend","rotate","rotatestart","rotatend","singlePinchstart","singlePinch","singlePinchend","singleRotate","singleRotatestart","singleRotatend"],f=["touchstart","touchmove","touchend","touchcancel"];e.prototype._driveBus=function(){var t=this;u.forEach(function(e){t[e]=new l(t.el)})},e.prototype._bind=function(){var t=this;f.forEach(function(e){var i="touchcancel"==e?"end":e.replace("touch","");t["_"+i+"_bind"]=t["_"+i].bind(t),t.el.addEventListener(e,t["_"+i+"_bind"],!1)})},e.prototype.destroy=function(){var t=this;f.forEach(function(e){var i="touchcancel"==e?"end":e.replace("touch","");t.el.removeEventListener(e,t["_"+i+"_bind"],!1)})},e.prototype._start=function(t){if(t.touches&&"touchstart"===t.type){if(this.fingers=t.touches.length,this.startPoint=h.getPoint(t,0),this.singleBasePoint=h.getBasePoint(this.operator),this.fingers>1)this.secondPoint=h.getPoint(t,1),this.vector1=h.getVector(this.secondPoint,this.startPoint),this.pinchStartLength=h.getLength(this.vector1);else if(this.use.singlePinch){var e=h.getVector(this.startPoint,this.singleBasePoint);this.singlePinchStartLength=h.getLength(e)}this.touchstart.fire({origin:t,eventType:"touchstart"})}},e.prototype._move=function(t){if(t.touches&&"touchmove"===t.type){var e=h.data(t.target,"singleButton"),i=t.touches.length,n=h.getPoint(t,0),o=void 0,s=void 0,r=void 0,a=void 0,c=void 0;if(i<this.fingers)return this.startPoint=n,void(this.fingers=i);if(!(i>1)||this.secondPoint&&this.vector1&&this.pinchStartLength||(this.secondPoint=h.getPoint(t,1),this.vector1=h.getVector(this.secondPoint,this.startPoint),this.pinchStartLength=h.getLength(this.vector1)),i>1){var l=h.getPoint(t,1),d=h.getVector(l,n);this.use.pinch&&(s=h.getLength(d),this._eventFire("pinch",{delta:{scale:s/this.pinchStartLength},origin:t}),this.pinchStartLength=s),this.use.rotate&&(this._eventFire("rotate",{delta:{rotate:h.getAngle(this.vector1,d)},origin:t}),this.vector1=d)}else this.use.singlePinch&&e&&(c=h.getVector(n,this.singleBasePoint),o=h.getLength(c),this._eventFire("singlePinch",{delta:{scale:o/this.singlePinchStartLength},origin:t}),this.singlePinchStartLength=o),this.use.singleRotate&&e&&(r=h.getVector(this.startPoint,this.singleBasePoint),a=h.getVector(n,this.singleBasePoint),this._eventFire("singleRotate",{delta:{rotate:h.getAngle(r,a)},origin:t}));this.use.drag&&(e||this._eventFire("drag",{delta:{deltaX:n.x-this.startPoint.x,deltaY:n.y-this.startPoint.y},origin:t})),this.startPoint=n,this.touchmove.fire({eventType:"touchmove",origin:t}),t.preventDefault()}},e.prototype._end=function(t){var e=this;(t.touches||"touchend"===t.type||"touchcancel"===t.type)&&(["pinch","drag","rotate","singleRotate","singlePinch"].forEach(function(i){e._eventEnd(i,{origin:t})}),this.touchend.fire({eventType:"touchend",origin:t}))},e.prototype._eventFire=function(t,e){var i=t+"ing",n=t+"start";this[i]?(e.eventType=t,this[t].fire(e)):(e.eventType=n,this[n].fire(e),this[i]=!0)},e.prototype._eventEnd=function(t,e){var i=t+"ing",n=void 0;n="rotate"==t||"singleRotate"==t?t+"nd":t+"end",this[i]&&(e.eventType=n,this[n].fire(e),this[i]=!1)},e.prototype._addButton=function(t){var e=h.domify("<div class=\"mtouch-singleButton\" data-singleButton='true' style='position:absolute;right:-15px;bottom: -15px;width:30px;height: 30px;background-size: 100% 100%;'></div>"),i=d(e,1),n=i[0],o=void 0;t.appendChild(n),t.setAttribute("data-mtouch-addButton",!0),getComputedStyle&&"static"===window.getComputedStyle(t,null).position&&(o=t.style||"",t.style=o+"position:relative")},e.prototype.switch=function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=void 0;if(!t)return void(this.operator=this.el);this.operator=i=h.getEl(t),!h.data(i,"mtouch-addButton")&&(this.use.singleRotate||this.use.singlePinch)&&e&&this._addButton(i)},e.prototype.on=function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},n=arguments[2];return h.include(t," ")?t.split(" ").forEach(function(t){e._on(t,i,n)}):this._on(t,i,n),this},e.prototype._on=function(t,e,i){this.use[h.getUseName(t)]=!0,this[t].add(e),this.switch(i)},e.prototype.off=function(t,e){this[t].del(e)};var p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},g="function"==typeof Symbol&&"symbol"===p(Symbol.iterator)?function(t){return void 0===t?"undefined":p(t)}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":void 0===t?"undefined":p(t)},y={extend:function(t,e){for(var i in e)e.hasOwnProperty(i)&&("object"==g(e[i])?("object"===g(t[i])&&null!==t[i]||(t[i]={}),this.extend(t[i],e[i])):t[i]=e[i]);return t},loadImage:function(t,e,i){var n=new Image;0==t.indexOf("http")&&(n.crossOrigin="*"),n.onload=function(){e(n)},n.onerror=function(){i("img load error")},n.src=t},isArr:function(t){return"[object Array]"===Object.prototype.toString.call(t)},getImage:function(t,e){if("string"==typeof t)this.loadImage(t,function(t){e(t)},function(t){console.log(t)});else{if("object"!=(void 0===t?"undefined":g(t)))return void console.log("add image error");e(t)}},forin:function(t,e){for(var i in t)t.hasOwnProperty(i)&&e(i,t[i])}};i.prototype._init=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.ops.width,this.canvas.height=this.ops.height,this.ctx=this.canvas.getContext("2d")},i.prototype.background=function(t){var e=this;return!t&&this.bgConfig&&(t=this.bgConfig),this.bgConfig=t,this.queue.push(function(){t.color&&(e.ctx.fillStyle=t.color,e.ctx.fillRect(0,0,e.canvas.width,e.canvas.height)),t.image?y.getImage(t.image,function(i){e._background(i,t)}):console.error("background image error!")}),this},i.prototype._background=function(t,e){var i=t.naturalWidth/t.naturalHeight,n=this.canvas.width/this.canvas.height,o=void 0,s=void 0,r=void 0,a=void 0,h=void 0,c=void 0,l=void 0,d=void 0;switch(e.type){case"crop":o=e.left||0,s=e.top||0,i>n?(r=t.naturalHeight*n,a=t.naturalHeight):(r=t.naturalWidth,a=r/n),c=h=0,d=this.canvas.height,l=this.canvas.width;break;case"contain":s=o=0,r=t.naturalWidth,a=t.naturalHeight,i>n?(l=this.canvas.width,d=l/i,h=e.left||0,c=e.top||0==e.top?e.top:(this.canvas.height-d)/2):(d=this.canvas.height,l=d*i,c=e.top||0,h=e.left||0==e.left?e.left:(this.canvas.width-l)/2);break;case"origin":this.canvas.width=t.naturalWidth,this.canvas.height=t.naturalHeight,o=s=0,r=t.naturalWidth,a=t.naturalHeight,h=c=0,l=this.canvas.width,d=this.canvas.height;break;default:console.error("background type error!")}this.ctx.drawImage(t,o,s,r,a,h,c,l,d),this._next()},i.prototype.watermark=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments[1];if(!t)return void console.log("there is not image of watermark");var i=e.width,n=void 0===i?"40%":i,o=e.pos,s=void 0===o?"rightbottom":o,r=e.margin,a=void 0===r?20:r,h={x:0,y:0,scale:1,rotate:0};switch(s){case"leftTop":h.x="left:"+a,h.y="top:"+a;break;case"leftBottom":h.x="left:"+a,h.y="bottom:"+a;break;case"rightTop":h.x="right:"+a,h.y="top:"+a;break;case"rightBottom":h.x="right:"+a,h.y="bottom:"+a}return this.add(t,{width:n,pos:h}),this},i.prototype.add=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments[1],n={width:"100%",crop:{x:0,y:0,width:"100%",height:"100%"},pos:{x:0,y:0,scale:1,rotate:0}};return y.isArr(e)||(e=[{image:e,options:i}]),e.forEach(function(e){t.queue.push(function(){y.getImage(e.image,function(i){t._add(i,t._handleOps(y.extend(n,e.options),i))})})}),this},i.prototype._add=function(t,e){var i=t.naturalWidth/t.naturalHeight,n=void 0,o=void 0,s=void 0,r=void 0,a=e.crop,h=a.x,c=a.y,l=a.width,d=a.height,u=void 0,f=void 0,p=void 0,g=void 0,y=document.createElement("canvas"),m=y.getContext("2d"),v=1.4*i>5?5:1.4*i,x=void 0,b=void 0;y.width=t.naturalWidth*v,y.height=t.naturalHeight*v,u=-t.naturalWidth/2,f=-t.naturalHeight/2,p=t.naturalWidth,g=t.naturalHeight,m.translate(y.width/2,y.height/2),m.rotate(e.pos.rotate),m.drawImage(t,h,c,l,d,u,f,p,g),s=e.width*v,r=s/i,x=(v-1)*e.width/2,b=x/i,n=e.pos.x+s*(1-e.pos.scale)/2-x,o=e.pos.y+r*(1-e.pos.scale)/2-b,s*=e.pos.scale,r*=e.pos.scale,this.ctx.drawImage(y,n,o,s,r),y=m=null,this._next()},i.prototype._handleOps=function(t,e){var i=this.canvas.width,n=this.canvas.height,o=e.naturalWidth,s=e.naturalHeight,r=o/s,a=this._get(i,o,t.width,"pos"),h=void 0,c=void 0,l=t.crop,d=l.x,u=l.y,f=l.width,p=l.height,g={x:this._get(i,o,d,"crop"),y:this._get(n,s,u,"crop"),width:this._get(i,o,f,"crop"),height:this._get(n,s,p,"crop")};g.x>o&&(g.x=o),g.y>s&&(g.y=s),h=e.naturalWidth-g.x,c=e.naturalHeight-g.y,g.width>h&&(g.width=h),g.height>c&&(g.height=c);var y=t.pos,m=y.x,v=y.y,x=y.rotate,b=y.scale;return{width:a,crop:g,pos:{x:this._get(i,a,m,"pos"),y:this._get(n,a/r,v,"pos"),scale:b,rotate:parseFloat(x)*Math.PI/180}}},i.prototype.text=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments[1],n="helvetica neue,hiragino sans gb,Microsoft YaHei,arial,tahoma,sans-serif",o=this.canvas.width/20;return this.queue.push(function(){var s={width:300,align:"left",smallStyle:{font:.8*o+"px "+n,color:"#000",lineheight:.9*o},normalStyle:{font:o+"px "+n,color:"#000",lineheight:1.1*o},largeStyle:{font:1.3*o+"px "+n,color:"#000",lineheight:1.4*o},pos:{x:0,y:0}};s=y.extend(s,i),t._text(t._parse(e),s),t._next()}),this},i.prototype._parse=function(t){for(var e=t.split(/<s>|<b>/),i=[],n=0;n<e.length;n++){var o=e[n];if(/<\/s>|<\/b>/.test(o)){var s=/<\/s>/.test(o)?"</s>":"</b>",r=/<\/s>/.test(o)?"small":"large",a=e[n].split(s);i.push({type:r,text:a[0]}),a[1]&&i.push({type:"normal",text:a[1]})}else e[n]&&i.push({text:e[n],type:"normal"})}return i},i.prototype._text=function(t,e){var i=this;e.width=this._get(this.canvas.width,0,e.width,"pos");var n=void 0,o=1,s=0,r=function(t,e){var i=0,n=void 0;return t.forEach(function(t){(n=e[t.type+"Style"].lineheight)>i&&(i=n)}),i}(t,e),a=this._get(this.canvas.width,e.width,e.pos.x,"pos"),h=this._get(this.canvas.height,0,e.pos.y,"pos")+r;this.textData[o]={data:[],lineWidth:0},t.forEach(function(t){n=e[t.type+"Style"],i.ctx.font=n.font;var c=i.ctx.measureText(t.text).width,l=t.text.replace(/<br>/g,"|");if(s+c>e.width||-1!==l.indexOf("|"))for(var d=0,u=l.length;d<u;d++){var f=l[d];c=i.ctx.measureText(f).width,(s+c>e.width||"|"==f)&&(s=0,a=i._get(i.canvas.width,e.width,e.pos.x,"pos"),h+=r,o+=1,i.textData[o]={data:[],lineWidth:0},"|"==f)||(i.textData[o].data.push({context:f,x:a,y:h,style:n,width:c}),s+=c,a+=c,i.textData[o].lineWidth=s)}else i.textData[o].data.push({context:l,x:a,y:h,style:n,width:c}),s+=c,a+=c,i.textData[o].lineWidth=s}),y.forin(this.textData,function(t,n){var o=0;n.lineWidth<e.width&&("center"==e.align?o=(e.width-n.lineWidth)/2:"right"==e.align&&(o=e.width-n.lineWidth)),n.data.forEach(function(t){t.x+=o,i._fillText(t)})})},i.prototype._fillText=function(t){var e=t.context,i=t.x,n=t.y,o=t.style;this.ctx.font=o.font,this.ctx.textAlign=o.align,this.ctx.textBaseline="bottom",this.ctx.fillStyle=o.color,this.ctx.fillText(e,i,n)},i.prototype._get=function(t,e,i,n){var o=i;if("string"==typeof i)if(-1!==i.indexOf(":")&&"pos"==n){var s=i.split(":");switch(s[0]){case"left":case"top":o=+s[1].replace("px","");break;case"right":case"bottom":o=t-+s[1].replace("px","")-e}}else o=-1!==i.indexOf("px")?+i.replace("px",""):-1!==i.indexOf("%")?"crop"==n?e*+i.replace("%","")/100:t*+i.replace("%","")/100:"center"==i?(t-e)/2:+i;return o},i.prototype.draw=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){},i=void 0;return this.end=function(){setTimeout(function(){i=t.canvas.toDataURL("image/png"),e(i)},0)},this._next(),this},i.prototype._next=function(){this.queue.length>0?this.queue.shift()():this.end()};var m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},v=void 0,x={setPos:function(t,e){var i=JSON.stringify(e),n="translate3d("+e.x+"px,"+e.y+"px,0px) scale("+e.scale+") rotate("+e.rotate+"deg)";t=this.getEl(t),t.style.transform=n,t.style.webkitTransform=n,t.setAttribute("data-mtouch-status",i)},getPos:function(t){if(t){var e=void 0,i=window.getComputedStyle(t,null),n=i.transform||i.webkitTransform;return e=window.getComputedStyle&&"none"!==n?this.matrixTo(n):{x:0,y:0,scale:1,rotate:0},JSON.parse(t.getAttribute("data-mtouch-status"))||e}},extend:function(t,e){for(var i in e)e.hasOwnProperty(i)&&("object"!=m(e[i])||e[i]instanceof Node?t[i]=e[i]:("object"===m(t[i])&&null!==t[i]||(t[i]={}),this.extend(t[i],e[i])));return t},getOffset:function(t){t=this.getEl(t);var e={};return e.width=t.clientWidth||t.offsetWidth,e.height=t.clientHeight||t.offsetHeight,e},matrixTo:function(t){var e=t.replace("matrix(","").replace(")","").split(","),i=e[0],n=e[1],o=n/i,s=180*Math.atan(o)/Math.PI,r=i/Math.cos(Math.PI/180*s);return{x:parseInt(e[4]),y:parseInt(e[5]),scale:r,rotate:s}},domify:function(t){var e=document.implementation.createHTMLDocument();return e.body.innerHTML=t,e.body.children},getEl:function(t){if(!t)return void console.error("el error,there must be a el!");var e=void 0;if("string"==typeof t)e=document.querySelector(t);else{if(!(t instanceof Node))return void console.error("el error,there must be a el!");e=t}return e},addClass:function(t,e){var i=void 0;return t=this.getEl(t),i=this.trim(t.className)||"",-1==i.indexOf(e)&&(0==i.length?t.className=e:t.className=i+" "+e),this},trim:function(t){if("string"==typeof t)return t.replace(/(^\s*)|(\s*$)/g,"")},removeClass:function(t,e){var i=void 0;t=this.getEl(t),i=t.className||"",-1!==i.indexOf(e)&&(t.className=i.replace(new RegExp(e,"g"),""))},hasClass:function(t,e){return t=this.getEl(t),-1!==t.className.indexOf(e)},forin:function(t,e){for(var i in t)t.hasOwnProperty(i)&&e(i,t[i])},data:function(t,e,i){return t=this.getEl(t),i?(t.setAttribute("data-"+e,i),this):t.getAttribute("data-"+e)},include:function(t,e){return!!t.indexOf&&-1!==t.indexOf(e)},delegate:function(t,e,i){var n=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){},s=this.getEl(t);s.addEventListener(e,function(t){for(var e=t.target;e!==s;){if(0==i.indexOf(".")){if(n.include(e.className,i.substring(1))){t.delegateTarget=e,o.bind(e)(t);break}}else if(0==i.indexOf("#")){if(e.id==i.substring(1)){t.delegateTarget=e,o.bind(e)(t);break}}else if(e.tagName.toLowerCase()==i){t.delegateTarget=e,o.bind(e)(t);break}e=e.parentNode}})},addCssRule:function(t,e){v||(v=n()),v.insertRule(t+"{"+e+"}",v.rules.length)},remove:function(t){(t.parentNode||t.parentElement).removeChild(t)},loadImage:function(t,e,i){var n=new Image,o=!1;0==t.indexOf("http")&&(n.crossOrigin="*"),n.onload=function(){o||(o=!0,e(n))},n.onerror=function(){i("img load error")},n.src=t},getImage:function(t,e){if("string"==typeof t)this.loadImage(t,function(t){e(t)},function(t){console.log(t)});else{if(!("object"==(void 0===t?"undefined":m(t))&&t instanceof Node))return void console.log("add image error");e(t)}},isArr:function(t){return"[object Array]"===Object.prototype.toString.call(t)}},b=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),_=function(){function t(e){o(this,t),this.config={min:50,max:100},this.config=x.extend(this.config,e),this.topIndex=this.config.min,this.zIndexArr=[]}return b(t,[{key:"init",value:function(){this.zIndexArr=[],this.topIndex=this.config.min}},{key:"setIndex",value:function(t){if(this.zIndexArr.push(t),this.topIndex>this.config.max)this.resetIndex();else{document.querySelector("#"+t).style.zIndex=this.topIndex,this.topIndex++}}},{key:"removeIndex",value:function(t){this.zIndexArr.forEach(function(e,i,n){e==t&&n.splice(i,1)})}},{key:"resetIndex",value:function(){var t=this;this.zIndexArr.forEach(function(e,i){document.querySelector("#"+e).style.zIndex=t.config.min+i}),this.topIndex=this.zIndexArr.length+this.config.min}},{key:"toTop",value:function(t){t!==this.zIndexArr[this.zIndexArr.length-1]&&(this.removeIndex(t),this.setIndex(t))}}]),t}(),w="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},S=["touchstart","touchmove","touchend","drag","dragstart","dragend","pinch","pinchstart","pinchend","rotate","rotatestart","rotatend","singlePinchstart","singlePinch","singlePinchend","singleRotate","singleRotatestart","singleRotatend"];return window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),s.prototype._init=function(){this.operator=null,this.operatorStatus=null,this.transform=null,this.freezed=!1,this._childs={},this._childIndex=0,this._activeChild=null,this._zIndexBox=new _},s.prototype.background=function(t){var e=this,i={image:"",type:"contain",left:0,top:0,use:{drag:!0}};return i=x.extend(i,t),x.getImage(i.image,function(t){var n=t.naturalWidth,o=t.naturalHeight,s=n/o,r=e.elStatus.width,a=e.elStatus.height,h=r/a,c=void 0,l=void 0,d=void 0,u=void 0,f=0,p=0,g=void 0;x.addClass(t,"mt-background").data(t,"mt-index","background").data(t,"mt-bg-type",i.type),"contain"==i.type?s>h?(c=i.left||0,l=i.top||(a-r/s)/2,d=r,u=r/s,g=n/d):(c=i.left||(r-a*s)/2,l=i.top||0,d=a*s,u=a,g=o/u):"crop"==i.type&&(c=0,l=0,s>h?(d=a*s,u=a,f=(d-r)/d,g=o/u):(d=r,u=r/s,p=(u-a)/u,g=n/d),i.limit={x:f,y:p,maxScale:1,minScale:1}),t.style="width:"+d+"px;height:"+u+"px;left:"+c+"px;top:"+l+"px",e.el.appendChild(t),i.ratio=g,i.left=c,i.top=l,e._childs.background={el:t,ops:i}}),this},s.prototype.add=function(t){var e=this,i={image:"",width:"",use:{drag:!1,pinch:!1,rotate:!1,singlePinch:!1,singleRotate:!1},limit:!1,pos:{x:0,y:0,scale:1,rotate:0},close:!1};return x.isArr(t)||(t=[t]),t.forEach(function(t){x.getImage(t.image,function(n){e._add(n,x.extend(i,t))})}),this},s.prototype._add=function(t,e){var i=t.naturalWidth,n=t.naturalHeight,o=i/n,s=t,r=x.domify('<div class="mt-child" id="mt-child-'+this._childIndex+'" data-mt-index="'+this._childIndex+'"></div>')[0],a=this._get("hor",e.width),h=a/o,c=(e.pos.scale-1)*a/2,l=(e.pos.scale-1)*h/2;r.style="width:"+a+"px;height:"+h+"px",x.addClass(s,"mt-image"),r.appendChild(s),(e.close||this._ops.close)&&r.appendChild(x.domify('<div class="mt-close-btn"></div>')[0]),this.el.appendChild(r),this._childs[this._childIndex]={el:r,ops:e},this._zIndexBox.setIndex("mt-child-"+this._childIndex);var d=!!(e.use.singlePinch||this._ops.use.singlePinch||e.use.singleRotate||this._ops.use.singleRotate);this.switch(r,d),this._setTransform(r,{x:this._get("hor",e.pos.x)+c,y:this._get("ver",e.pos.y)+l,scale:e.pos.scale,rotate:e.pos.rotate}),this._childIndex++},s.prototype.exportImage=function(t){var e=this.elStatus.width,n=this.elStatus.height,o=this._childs.background,s=void 0,r=void 0,a=o.ops.ratio,h=new i(e*a,n*a),c=[];if(this._zIndexBox.zIndexArr.forEach(function(t){var e=document.querySelector("#"+t),i=e.querySelector(".mt-image"),n=JSON.parse(x.data(e,"mtouch-status")),o=i.clientWidth||i.offsetWidth;n.x*=a,n.y*=a,c.push({image:i,options:{width:o*a,pos:n}})}),"crop"==o.ops.type){var l=JSON.parse(x.data(o.el,"mtouch-status"))||{left:0,top:0,scale:1,rotate:0};s=-l.x,r=-l.y}else s=o.ops.left,r=o.ops.top;h.background({image:o.el,type:o.ops.type,left:s*a,top:r*a}).add(c).draw(function(e){t(e)})},s.prototype._bind=function(){var t=this;S.forEach(function(e){t[e]||(t[e]=function(){t._ops.event[e]()}),t.mt.on(e,t[e].bind(t))}),this.el.addEventListener("click",function(e){t._isAdd(e.target)||t.switch(null),x.hasClass(e.target,"mt-background")&&"crop"==x.data(e.target,"mt-bg-type")&&t.switch(e.target)}),x.delegate(this.el,"click",".mt-child",function(e){var i=e.delegateTarget,n=t._getOperatorOps(i),o=!!(n.use.singlePinch||t._ops.use.singlePinch||n.use.singleRotate||t._ops.use.singleRotate);t.switch(i,o),t._zIndexBox.toTop(i.id)}),x.delegate(this.el,"click",".mt-close-btn",function(e){var i=e.delegateTarget,n=i.parentNode||i.parentElement;t._zIndexBox.removeIndex(n.id),x.remove(n)})},s.prototype.touchstart=function(t){this.freezed||(this.operator&&(this.transform=x.getPos(this.operator)),this._ops.event.touchstart(t))},s.prototype.drag=function(t){if(!this.freezed){if(this.operator){(this._getOperatorOps().use.drag||this._ops.use.drag)&&(this.transform.x+=t.delta.deltaX,this.transform.y+=t.delta.deltaY,this._setTransform())}this._ops.event.drag(t)}},s.prototype.pinch=function(t){if(!this.freezed){if(this.operator){(this._getOperatorOps().use.pinch||this._ops.use.pinch)&&(this.transform.scale*=t.delta.scale,this._setTransform())}this._ops.event.pinch(t)}},s.prototype.rotate=function(t){if(!this.freezed){if(this.operator){(this._getOperatorOps().use.rotate||this._ops.use.rotate)&&(this.transform.rotate+=t.delta.rotate,this._setTransform())}this._ops.event.rotate(t)}},s.prototype.singlePinch=function(t){if(!this.freezed){if(this.operator){(this._getOperatorOps().use.singlePinch||this._ops.use.singlePinch)&&(this.transform.scale*=t.delta.scale,this._setTransform())}this._ops.event.singlePinch(t)}},s.prototype.singleRotate=function(t){if(!this.freezed){if(this.operator){(this._getOperatorOps().use.singleRotate||this._ops.use.singleRotate)&&(this.transform.rotate+=t.delta.rotate,this._setTransform())}this._ops.event.singleRotate(t)}},s.prototype._setTransform=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.operator,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.transform,i=JSON.parse(JSON.stringify(e)),n=this._getOperatorOps(),o=this._ops.limit&&"object"==w(this._ops.limit)?x.extend({x:.5,y:.5,maxScale:3,minScale:.4},this._ops.limit):{x:.5,y:.5,maxScale:3,minScale:.4},s=n.limit&&!0!==n.limit?x.extend(o,n.limit):o;if((n.limit||this._ops.limit)&&(i=this._limitOperator(i,s)),n.use.singlePinch||this._ops.use.singlePinch){var r=t.querySelector(".mtouch-singleButton");r.style.transform="scale("+1/i.scale+")",r.style.webkitTransform="scale("+1/i.scale+")"}if(n.use.singleRotate||this._ops.use.singleRotate){var a=t.querySelector(".mtouch-singleButton");a.style.transform="scale("+1/i.scale+")",a.style.webkitTransform="scale("+1/i.scale+")"}if(n.close||this._ops.close){var h=t.querySelector(".mt-close-btn");h.style.transform="scale("+1/i.scale+")",h.style.webkitTransform="scale("+1/i.scale+")"}window.requestAnimFrame(function(){x.setPos(t,i)})},s.prototype._limitOperator=function(t,e){var i=e.minScale,n=e.maxScale;i&&t.scale<i&&(t.scale=i),n&&t.scale>n&&(t.scale=n);var o=x.getOffset(this.operator),s=o.width*(t.scale-1)/2,r=o.height*(t.scale-1)/2,a=o.width*t.scale*e.x,h=o.height*t.scale*e.y,c=s-a,l=s-h,d=this.elStatus.width-o.width*t.scale+s+a,u=this.elStatus.height-o.height*t.scale+r+h;return(e.x||0==e.x)&&(t.x>=d&&(t.x=d),t.x<c&&(t.x=c)),(e.y||0==e.y)&&(t.y>u&&(t.y=u),t.y<l&&(t.y=l)),t},s.prototype.switch=function(t,e){if(this.mt&&!this.freezed)return t&&(t=x.getEl(t)),x.forin(this._childs,function(t,e){x.removeClass(e.el,"mt-active")}),this.mt.switch(t,e),this.operator=t,t&&(x.addClass(t,"mt-active"),this._activeChild=t),this},s.prototype._getOperatorOps=function(t){var e=t||this.operator,i=x.data(e,"mt-index");return this._childs[i].ops},s.prototype.freeze=function(t){return t?x.forin(this._childs,function(t,e){x.removeClass(e.el,"mt-active")}):x.addClass(this._activeChild,"mt-active"),this.freezed=!!t,this},s.prototype.reset=function(){x.forin(this._childs,function(t,e){x.remove(e.el)}),this._init()},s.prototype.destory=function(){x.forin(this._childs,function(t,e){x.removeClass(e.el,"mt-active")}),this.mt&&this.mt.destroy(),this.mt=null},s.prototype._get=function(t,e){var i=e,n=void 0,o=void 0,s=void 0;if(n=document.body&&document.body.clientWidth?"hor"==t?"clientWidth":"clientHeight":"hor"==t?"offsetWidth":"offsetHeight",o=this.el[n],s=this.operator?this.operator[n]:0,"string"==typeof e)if(x.include(e,":")){var r=e.split(":");switch(r[0]){case"left":case"top":i=+r[1].replace("px","");break;case"right":case"bottom":i=o-+r[1].replace("px","")-s}}else i=x.include(e,"px")?+e.replace("px",""):x.include(e,"%")?o*+e.replace("%","")/100:"center"==e?(o-s)/2:+e;return i},s.prototype._isAdd=function(t){for(var e=t;e!==this.el||"body"==e.tagName.toLowerCase();){if(x.include(e.className,"mt-child"))return!0;e=e.parentNode}return!1},s.prototype._insertCss=function(){x.addCssRule(".mtouch-singleButton","display: none;"),x.addCssRule(".mt-child.mt-active","z-index: 99;outline:2px solid hsla(0,0%,100%,.5);"),x.addCssRule(".mt-active .mtouch-singleButton,.mt-active .mt-close-btn","display: inline-block;"),x.addCssRule(".mt-child","position:absolute;text-align:left;"),x.addCssRule(".mt-image","width:100%;height:100%;position:absolute;text-align:left;"),x.addCssRule(".mt-close-btn","position:absolute;width:30px;height:30px;top:-15px;right:-15px;background-size:100%;display:none;"),x.addCssRule(".mt-background","position:absolute;left:0;top:0;")},s});
//# sourceMappingURL=touchkit.min.js.map
